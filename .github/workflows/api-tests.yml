name: API Tests (Postman + Newman)

on:
  push:
  pull_request:

jobs:
  api-tests:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017

    steps:
      - name: Checkout tests repo
        uses: actions/checkout@v4

      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          repository: silumi95/automation-engineer-test-be
          path: backend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check backend directory structure
        run: |
          echo "Checking backend directory structure..."
          ls -la backend/
          echo "Looking for server.js..."
          find backend -name "server.js" -type f

      - name: Install backend dependencies
        working-directory: backend
        run: |
          echo "Installing backend dependencies..."
          npm install

      - name: Install required tools
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd curl

      - name: Wait for MongoDB
        run: |
          echo "Waiting for MongoDB..."
          for i in {1..30}; do
            nc -z localhost 27017 && echo "MongoDB ready" && break
            sleep 2
          done

      - name: Setup backend environment
        working-directory: backend
        run: |
          echo "Setting up backend environment..."
          echo "PORT=8000" > .env
          echo "MONGO_URI=mongodb://127.0.0.1:27017/qa_test_db" >> .env
          echo "NODE_ENV=development" >> .env
          echo "JWT_SECRET=test-jwt-secret-for-ci-12345-67890" >> .env
          echo "Environment file created"

      - name: Find and start backend server
        working-directory: backend
        run: |
          echo "Looking for server entry point..."
          
          # Check common server file locations
          if [ -f "server.js" ]; then
            SERVER_FILE="server.js"
            echo "Found server.js in root"
          elif [ -f "src/server.js" ]; then
            SERVER_FILE="src/server.js"
            echo "Found server.js in src/"
          elif [ -f "index.js" ]; then
            SERVER_FILE="index.js"
            echo "Found index.js"
          elif [ -f "app.js" ]; then
            SERVER_FILE="app.js"
            echo "Found app.js"
          else
            echo "Error: Could not find server entry point!"
            echo "Files in backend directory:"
            ls -la
            echo "Files in backend/src directory (if exists):"
            ls -la src/ 2>/dev/null || echo "No src directory"
            exit 1
          fi
          
          echo "Starting server from: $SERVER_FILE"
          
          # Start server in background
          nohup node $SERVER_FILE > server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > server.pid
          
          echo "Server started with PID: $SERVER_PID"
          echo "Waiting for server to be ready..."
          
          # Wait for server with retries
          MAX_RETRIES=30
          RETRY_COUNT=0
          SERVER_READY=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Checking server (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            
            # Check if process is still running
            if ! ps -p $SERVER_PID > /dev/null 2>&1; then
              echo "Server process died!"
              if [ -f server.log ]; then
                echo "=== Server logs ==="
                tail -100 server.log
              fi
              exit 1
            fi
            
            # Try to connect to server
            if curl -s -f http://localhost:8000 > /dev/null 2>&1; then
              echo "Server is responding on root endpoint"
              SERVER_READY=true
              break
            elif curl -s -f http://localhost:8000/api/docs > /dev/null 2>&1; then
              echo "Server is responding on /api/docs"
              SERVER_READY=true
              break
            elif curl -s -f http://localhost:8000/api/user/register > /dev/null 2>&1; then
              echo "Server is responding on /api/user/register"
              SERVER_READY=true
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 2
          done
          
          if [ "$SERVER_READY" = false ]; then
            echo "Server failed to start within timeout"
            if [ -f server.log ]; then
              echo "=== Server logs (last 200 lines) ==="
              tail -200 server.log
            fi
            exit 1
          fi
          
          echo "Server is ready and responding"
          
          # Test API endpoint
          echo "Testing API endpoint..."
          curl -s -X POST http://localhost:8000/api/user/register \
            -H "Content-Type: application/json" \
            -d '{"name":"Test User","email":"test@example.com","password":"Test123!"}' \
            -w " -> Status: %{http_code}\n" || echo "API test failed"

      - name: Create admin user for testing
        working-directory: backend
        run: |
          echo "Creating admin user for testing..."
          
          # First, register a user via API. The backend will assign the default 'worker' role.
          # We check for status 200 (created) or 400 (user already exists), both are acceptable here.
          REGISTER_RESPONSE=$(curl -s -X POST http://localhost:8000/api/user/register \
            -H "Content-Type: application/json" \
            -d '{"name":"Admin User","email":"admin@example.com","password":"AdminPass123!"}' \
            -w "\nStatus: %{http_code}")
          
          echo "Admin user registration response: $REGISTER_RESPONSE"
          
          if [[ ! "$REGISTER_RESPONSE" =~ "Status: 200" && ! "$REGISTER_RESPONSE" =~ "Status: 400" ]]; then
            echo "Admin user registration failed with an unexpected status."
            exit 1
          fi
          
          echo "User 'admin@example.com' registered. Now promoting to admin role directly in the database."
          
          # We need to elevate this user to 'admin'. The API for promotion requires admin rights,
          # creating a chicken-and-egg problem for the first admin. So, we'll update the role directly in MongoDB.
          node -e "
            const mongoose = require('mongoose');
            mongoose.connect('mongodb://127.0.0.1:27017/qa_test_db')
              .then(() => {
                console.log('Connected to DB for admin promotion.');
                return mongoose.connection.db.collection('users').updateOne({ email: 'admin@example.com' }, { \$set: { role: 'admin' } });
              })
              .then(result => {
                if (result.matchedCount === 0) throw new Error('User admin@example.com not found in database.');
                if (result.modifiedCount === 1) console.log('Successfully promoted admin@example.com to admin.');
                else console.log('User admin@example.com was already an admin.');
                return mongoose.disconnect();
              })
              .catch(err => {
                console.error('Admin promotion script failed:', err.message);
                process.exit(1);
              });
          "

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Check Postman files
        run: |
          echo "Checking Postman files..."
          ls -la Backend-repo/postman/
          echo "Collection file exists:"
          [ -f "Backend-repo/postman/E2E Shift Management.postman_collection.json" ] && echo "YES" || echo "NO"
          echo "Environment file exists:"
          [ -f "Backend-repo/postman/QA Environment.postman_environment.json" ] && echo "YES" || echo "NO"

      - name: Run Postman collection
        run: |
          echo "Starting Postman tests..."
          
          # Check if collection exists
          if [ ! -f "Backend-repo/postman/E2E Shift Management.postman_collection.json" ]; then
            echo "Error: Postman collection not found!"
            echo "Available files in Backend-repo/postman/:"
            ls -la Backend-repo/postman/
            exit 1
          fi
          
          # Run tests
          echo "Running Newman tests..."
          newman run "Backend-repo/postman/E2E Shift Management.postman_collection.json" \
            -e "Backend-repo/postman/QA Environment.postman_environment.json" \
            --env-var "baseUrl=http://localhost:8000" \
            --env-var "adminEmail=admin@example.com" \
            --env-var "adminPassword=AdminPass123!" \
            --timeout 300000 \
            --timeout-request 60000 \
            --timeout-script 60000 \
            --disable-unicode \
            -r cli,json,htmlextra \
            --reporter-json-export newman-report.json \
            --reporter-htmlextra-export newman-report.html \
            --suppress-exit-code
          
          echo "Newman tests completed"

      - name: Show test results summary
        if: always()
        run: |
          echo "=== Test Results Summary ==="
          if [ -f newman-report.json ]; then
            echo "Report exists"
            
            # Install jq if not available
            if ! command -v jq &> /dev/null; then
              sudo apt-get install -y jq
            fi
            
            TOTAL_REQUESTS=$(jq '.run.stats.requests.total' newman-report.json 2>/dev/null || echo "N/A")
            FAILED_REQUESTS=$(jq '.run.stats.requests.failed' newman-report.json 2>/dev/null || echo "N/A")
            TOTAL_TESTS=$(jq '.run.stats.assertions.total' newman-report.json 2>/dev/null || echo "N/A")
            FAILED_TESTS=$(jq '.run.stats.assertions.failed' newman-report.json 2>/dev/null || echo "N/A")
            
            echo "Total Requests: $TOTAL_REQUESTS"
            echo "Failed Requests: $FAILED_REQUESTS"
            echo "Total Tests: $TOTAL_TESTS"
            echo "Failed Tests: $FAILED_TESTS"
            
            if [ "$FAILED_REQUESTS" != "0" ] || [ "$FAILED_TESTS" != "0" ]; then
              echo "Some tests failed"
              echo "=== First few failures ==="
              jq -r '.run.failures[0:5][] | "\(.source.name): \(.error.test // .error.message)"' newman-report.json 2>/dev/null || echo "Could not parse failures"
            else
              echo "All tests passed!"
            fi
          else
            echo "No test report generated"
          fi

      - name: Show server logs if tests failed
        if: failure()
        working-directory: backend
        run: |
          echo "=== SERVER LOGS (last 200 lines) ==="
          if [ -f server.log ]; then
            tail -200 server.log
          else
            echo "No server logs found"
          fi

      - name: Stop backend server
        if: always()
        working-directory: backend
        run: |
          echo "Cleaning up server processes..."
          if [ -f server.pid ]; then
            PID=$(cat server.pid)
            echo "Stopping server with PID: $PID"
            kill $PID 2>/dev/null || true
            sleep 1
            kill -9 $PID 2>/dev/null || true
            rm -f server.pid
          fi
          
          pkill -f "node" 2>/dev/null || true

      - name: Upload Newman report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            newman-report.json
            newman-report.html
            backend/server.log
          retention-days: 7