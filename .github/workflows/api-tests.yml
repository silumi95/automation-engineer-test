name: API Tests (Postman + Newman)

on:
  push:
  pull_request:

jobs:
  api-tests:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017

    steps:
      - name: Checkout tests repo
        uses: actions/checkout@v4

      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          repository: silumi95/automation-engineer-test-be
          path: backend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check backend directory structure
        run: |
          echo "Checking backend directory structure..."
          ls -la backend/
          echo "Looking for server.js..."
          find backend -name "server.js" -type f

      - name: Install backend dependencies
        working-directory: backend
        run: |
          echo "Installing backend dependencies..."
          npm ci

      - name: Install required tools
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd curl

      - name: Wait for MongoDB
        run: |
          echo "Waiting for MongoDB..."
          for i in {1..30}; do
            nc -z localhost 27017 && echo "MongoDB ready" && break
            sleep 2
          done

      - name: Setup backend environment
        working-directory: backend
        run: |
          echo "Setting up backend environment..."
          cat > .env << EOF
          PORT=8000
          MONGO_URI=mongodb://127.0.0.1:27017/qa_test_db
          NODE_ENV=development
  
          EOF
          echo "Environment file created"

      - name: Find and start backend server
        working-directory: backend
        run: |
          echo "Looking for server entry point..."
          
          # Check common server file locations
          if [ -f "server.js" ]; then
            SERVER_FILE="server.js"
            echo "Found server.js in root"
          elif [ -f "src/server.js" ]; then
            SERVER_FILE="src/server.js"
            echo "Found server.js in src/"
          elif [ -f "index.js" ]; then
            SERVER_FILE="index.js"
            echo "Found index.js"
          elif [ -f "app.js" ]; then
            SERVER_FILE="app.js"
            echo "Found app.js"
          else
            echo "Error: Could not find server entry point!"
            ls -la
            exit 1
          fi
          
          echo "Starting server from: $SERVER_FILE"
          
          # Start server in background
          nohup node $SERVER_FILE > server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > server.pid
          
          echo "Server started with PID: $SERVER_PID"
          echo "Waiting for server to be ready..."
          
          # Wait for server with retries
          MAX_RETRIES=30
          RETRY_COUNT=0
          SERVER_READY=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Checking server (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            
            # Check if process is still running
            if ! ps -p $SERVER_PID > /dev/null 2>&1; then
              echo "Server process died!"
              if [ -f server.log ]; then
                echo "=== Server logs ==="
                tail -100 server.log
              fi
              exit 1
            fi
            
            # Check health endpoint
            if curl -s -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "Server health check passed"
              SERVER_READY=true
              break
            elif curl -s -f http://localhost:8000/api/user/register > /dev/null 2>&1; then
              echo "Server API is responding"
              SERVER_READY=true
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 2
          done
          
          if [ "$SERVER_READY" = false ]; then
            echo "Server failed to start within timeout"
            if [ -f server.log ]; then
              echo "=== Server logs (last 200 lines) ==="
              tail -200 server.log
            fi
            exit 1
          fi
          
          echo "Server is ready and responding"

      - name: Create only admin user (required for Postman tests)
        working-directory: backend
        run: |
          echo "Creating ONLY admin user for Postman tests..."
          echo "Postman will create all other users (workers, test users, etc.)"
          
          # Create admin user directly in database to avoid circular dependency
          node -e "
            const mongoose = require('mongoose');
            const bcrypt = require('bcrypt');
            
            async function createAdminUser() {
              try {
                await mongoose.connect('mongodb://127.0.0.1:27017/qa_test_db');
                console.log('Connected to database');
                
                const db = mongoose.connection.db;
                
                // Clean up ONLY the admin user to avoid conflicts
                console.log('Cleaning old admin user if exists...');
                await db.collection('users').deleteOne({ 
                  email: 'john@example.com'
                });
                
                // Create admin user with hashed password
                console.log('Creating admin user...');
                const hashedPassword = await bcrypt.hash('StrongPass123!', 10);
                await db.collection('users').insertOne({
                  name: 'Admin User',
                  email: 'john@example.com',
                  password: hashedPassword,
                  role: 'admin',
                  createdAt: new Date(),
                  updatedAt: new Date()
                });
                
                console.log('✓ Admin user created: john@example.com / StrongPass123!');
                console.log('✓ Role: admin');
                
                // Count total users (should be 1 - just the admin)
                const userCount = await db.collection('users').countDocuments();
                console.log(\`Total users in database: \${userCount}\`);
                
                await mongoose.disconnect();
                console.log('✓ Admin user setup complete');
              } catch (error) {
                console.error('Error creating admin user:', error.message);
                process.exit(1);
              }
            }
            
            createAdminUser();
          "

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Check Postman files
        run: |
          echo "Checking Postman files..."
          ls -la Backend-repo/postman/
          echo "Collection file:"
          [ -f "Backend-repo/postman/E2E Shift Management.postman_collection.json" ] && echo "✓ Found" || echo "✗ Missing"
          echo "Environment file:"
          [ -f "Backend-repo/postman/QA Environment.postman_environment.json" ] && echo "✓ Found" || echo "✗ Missing"

      - name: Run Postman collection
        run: |
          echo "Starting Postman tests..."
          echo "Note: Postman will create its own test users (workers, etc.)"
          
          if [ ! -f "Backend-repo/postman/E2E Shift Management.postman_collection.json" ]; then
            echo "Error: Postman collection not found!"
            ls -la Backend-repo/postman/
            exit 1
          fi
          
          echo "Running Newman tests..."
          echo "Admin credentials: john@example.com / StrongPass123!"
          
          # Run tests with only admin credentials
          # Postman will create other users as needed
          newman run "Backend-repo/postman/E2E Shift Management.postman_collection.json" \
            -e "Backend-repo/postman/QA Environment.postman_environment.json" \
            --env-var "baseUrl=http://localhost:8000" \
            --env-var "adminEmail=john@example.com" \
            --env-var "adminPassword=StrongPass123!" \
            --timeout 300000 \
            --timeout-request 60000 \
            --timeout-script 60000 \
            --disable-unicode \
            -r cli,json,htmlextra \
            --reporter-json-export newman-report.json \
            --reporter-htmlextra-export newman-report.html \
            --suppress-exit-code
          
          NEWMAN_EXIT_CODE=$?
          echo "Newman tests completed with exit code: $NEWMAN_EXIT_CODE"

      - name: Show test results summary
        if: always()
        run: |
          echo "### API Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          
          if [ -f newman-report.json ]; then
            if ! command -v jq &> /dev/null; then
              sudo apt-get install -y jq
            fi
            
            TOTAL_REQUESTS=$(jq '.run.stats.requests.total' newman-report.json)
            FAILED_REQUESTS=$(jq '.run.stats.requests.failed' newman-report.json)
            TOTAL_ASSERTIONS=$(jq '.run.stats.assertions.total' newman-report.json)
            FAILED_ASSERTIONS=$(jq '.run.stats.assertions.failed' newman-report.json)
            
            echo "| Metric | Executed | Failed |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
            echo "| **Requests** | $TOTAL_REQUESTS | $FAILED_REQUESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| **Assertions** | $TOTAL_ASSERTIONS | $FAILED_ASSERTIONS |" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILED_ASSERTIONS" != "0" ] || [ "$FAILED_REQUESTS" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### Top Failures" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              jq -r '.run.failures[0:5][] | "- \(.source.name): \(.error.test // .error.message)"' newman-report.json >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            
            # Determine if tests passed
            if [ "$FAILED_ASSERTIONS" = "0" ] && [ "$FAILED_REQUESTS" = "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**All tests passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo " **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No test report generated" >> $GITHUB_STEP_SUMMARY
            echo " **Test execution failed**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Show server logs if tests failed
        if: failure()
        working-directory: backend
        run: |
          echo "=== SERVER LOGS (last 200 lines) ==="
          if [ -f server.log ]; then
            tail -200 server.log
          else
            echo "No server logs found"
          fi
          
          echo ""  
          echo "=== DATABASE STATE AFTER TESTS ==="
          node -e "
            const mongoose = require('mongoose');
            mongoose.connect('mongodb://127.0.0.1:27017/qa_test_db')
              .then(() => {
                console.log('Connected to check database state');
                return Promise.all([
                  mongoose.connection.db.collection('users').find({}).toArray(),
                  mongoose.connection.db.collection('shifts').find({}).toArray()
                ]);
              })
              .then(([users, shifts]) => {
                console.log(\`Users in DB: \${users.length}\`);
                users.forEach(u => console.log(\`- \${u.email} (role: \${u.role})\`));
                console.log(\`Shifts in DB: \${shifts.length}\`);
                return mongoose.disconnect();
              })
              .catch(err => {
                console.error('Error checking DB:', err.message);
              });
          "

      - name: Stop backend server
        if: always()
        working-directory: backend
        run: |
          echo "Cleaning up server processes..."
          if [ -f server.pid ]; then
            PID=$(cat server.pid)
            echo "Stopping server with PID: $PID"
            kill $PID 2>/dev/null || true
            sleep 1
            kill -9 $PID 2>/dev/null || true
            rm -f server.pid
          fi
          
          # Clean up any remaining node processes
          pkill -f "node" 2>/dev/null || true
          echo "Server cleanup completed"

      - name: Upload Newman report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            newman-report.json
            newman-report.html
            backend/server.log
          retention-days: 7