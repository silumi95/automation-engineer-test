name: API Tests (Postman + Newman)

on:
  push:
  pull_request:

jobs:
  api-tests:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017

    steps:
      - name: Checkout tests repo
        uses: actions/checkout@v4

      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          repository: silumi95/automation-engineer-test-be
          path: backend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install backend dependencies
        working-directory: backend
        run: npm install

      - name: Install required tools
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd curl jq

      - name: Wait for MongoDB
        run: |
          echo "Waiting for MongoDB..."
          for i in {1..30}; do
            nc -z localhost 27017 && echo "MongoDB ready" && break
            sleep 2
          done

      - name: Setup backend environment
        working-directory: backend
        run: |
          echo "PORT=8000" > .env
          echo "MONGO_URI=mongodb://127.0.0.1:27017/qa_test_db" >> .env
          echo "NODE_ENV=development" >> .env
          echo "JWT_SECRET=test-jwt-secret-for-ci-12345-67890" >> .env
          echo "Environment file created:"
          cat .env

      - name: Start backend server
        working-directory: backend
        run: |
          echo "Starting backend server..."
          nohup npm start > server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > server.pid
          
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s -f http://localhost:8000 > /dev/null 2>&1; then
              echo "Backend server is responding"
              break
            fi
            sleep 2
          done

      - name: Debug server status
        run: |
          echo "=== Server Status Check ==="
          ps aux | grep -E "(node|npm)" | grep -v grep || echo "No node processes found"
          netstat -tulpn | grep :8000 || echo "Nothing on port 8000"
          echo "=== Server Logs (last 10 lines) ==="
          if [ -f backend/server.log ]; then tail -10 backend/server.log; fi

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Run Postman collection
        run: |
          echo "Starting Postman tests using existing environment..."
          NEWMAN_COLLECTION="postman/E2E Shift Management.postman_collection.json"
          NEWMAN_ENV="postman/QA Environment.postman_environment.json"

          if [ ! -f "$NEWMAN_COLLECTION" ]; then
            echo "Error: Postman collection not found!"
            exit 1
          fi

          if [ ! -f "$NEWMAN_ENV" ]; then
            echo "Error: Postman environment not found!"
            exit 1
          fi

          newman run "$NEWMAN_COLLECTION" \
            -e "$NEWMAN_ENV" \
            --timeout 300000 \
            --timeout-request 60000 \
            --timeout-script 60000 \
            -r cli,htmlextra \
            --reporter-htmlextra-export newman-report.html \
            --reporter-json-export newman-report.json \
            --suppress-exit-code

      - name: Show test results summary
        if: always()
        run: |
          echo "=== Test Results Summary ==="
          if [ -f newman-report.json ]; then
            if command -v jq >/dev/null 2>&1; then
              TOTAL_REQUESTS=$(jq '.run.stats.requests.total' newman-report.json)
              FAILED_REQUESTS=$(jq '.run.stats.requests.failed' newman-report.json)
              TOTAL_TESTS=$(jq '.run.stats.assertions.total' newman-report.json)
              FAILED_TESTS=$(jq '.run.stats.assertions.failed' newman-report.json)
              
              echo "Total Requests: $TOTAL_REQUESTS"
              echo "Failed Requests: $FAILED_REQUESTS"
              echo "Total Tests: $TOTAL_TESTS"
              echo "Failed Tests: $FAILED_TESTS"
            fi
          else
            echo "No test report generated"
          fi

      - name: Show server logs on failure
        if: failure()
        working-directory: backend
        run: |
          echo "=== SERVER LOGS (last 50 lines) ==="
          if [ -f server.log ]; then tail -50 server.log; fi

      - name: Stop backend server
        if: always()
        working-directory: backend
        run: |
          echo "Stopping backend server..."
          if [ -f server.pid ]; then
            PID=$(cat server.pid)
            kill $PID 2>/dev/null || true
            rm -f server.pid
          fi
          pkill -f "node" 2>/dev/null || true

      - name: Upload Newman report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            newman-report.json
            newman-report.html
            backend/server.log
          retention-days: 7
