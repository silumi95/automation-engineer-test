name: Frontend Playwright Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone frontend app
        run: |
          git clone https://github.com/silumi95/automation-engineer-test-fe.git frontend-app

      - name: Setup Node.js 20
        uses: actions/setup-node@v4 
        with:
          node-version: 20

      - name: Install frontend deps
        working-directory: frontend-app
        run: npm ci

      - name: Install test deps and Playwright
        working-directory: Frontend
        run: |
          npm ci
          npx playwright install --with-deps

      - name: Start frontend server
        working-directory: frontend-app
        run: |
          echo "VITE_API_BASE_URL=https://automation-engineer-test-be.onrender.com/api" > .env
          echo "Frontend connecting to: https://automation-engineer-test-be.onrender.com/api"
          npm run dev &
          echo $! > server.pid
          
          sleep 10
          curl -s http://localhost:5173 && echo "Frontend server is ready"

      - name: Verify backend API
        run: |
          echo "Testing backend API connection..."
          curl -s https://automation-engineer-test-be.onrender.com/api/docs || curl -s https://automation-engineer-test-be.onrender.com || echo "Backend check"
          
          echo "Testing registration API..."
          curl -X POST https://automation-engineer-test-be.onrender.com/api/user/register \
            -H "Content-Type: application/json" \
            -d '{"name":"Test User","email":"test'$(date +%s)'@example.com","password":"TestPass123!"}' \
            -w "\nStatus: %{http_code}\n" -s || echo "API test"

      - name: Update test data to match backend
        working-directory: Frontend
        run: |
          echo "Checking test data..."
          if [ -f data.js ]; then
            echo "Updating test data to use email that might exist..."
            UNIQUE_EMAIL="test_$(date +%s)@example.com"
            sed -i "s|'john@example.com'|'$UNIQUE_EMAIL'|g" data.js
            sed -i "s|'newuser@example.com'|'$UNIQUE_EMAIL'|g" data.js
            echo "Test email updated to: $UNIQUE_EMAIL"
          fi

      - name: Run tests
        working-directory: Frontend
        env:
          BASE_URL: "http://localhost:5173"
          PLAYWRIGHT_JSON_OUTPUT_NAME: "playwright-report.json"
        run: |
          echo "Running Playwright tests against local frontend with LIVE backend..."
          npx playwright test --reporter=list,json

      - name: Show test results summary
        if: always()
        working-directory: Frontend
        run: |
          echo "### Playwright Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          
          if [ -f playwright-report.json ]; then
            if ! command -v jq &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y jq
            fi
            
            PASSED=$(jq '.stats.expected // 0' playwright-report.json)
            FAILED=$(jq '.stats.unexpected // 0' playwright-report.json)
            SKIPPED=$(jq '.stats.skipped // 0' playwright-report.json)
            FLAKY=$(jq '.stats.flaky // 0' playwright-report.json)
            TOTAL=$((PASSED + FAILED + SKIPPED + FLAKY))
            DURATION=$(jq '.stats.duration // 0' playwright-report.json)
            DURATION_SEC=$(awk "BEGIN {printf \"%.2f\", $DURATION/1000}")
            
            echo "| | executed | failed |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
            echo "| **Tests** | $TOTAL | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| **Passed** | $PASSED | 0 |" >> $GITHUB_STEP_SUMMARY
            echo "| **Skipped** | $SKIPPED | 0 |" >> $GITHUB_STEP_SUMMARY
            echo "| **Flaky** | $FLAKY | 0 |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total run duration:** ${DURATION_SEC}s" >> $GITHUB_STEP_SUMMARY
          else
            echo "No JSON report found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup
        if: always()
        run: |
          if [ -f frontend-app/server.pid ]; then
            kill $(cat frontend-app/server.pid) 2>/dev/null || true
          fi

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: Frontend/playwright-report/